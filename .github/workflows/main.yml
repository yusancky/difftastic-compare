name: Diff Comparison

on:
  push:
  workflow_dispatch:

jobs:
  diff-comparison:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
    - name: Install difftastic 0.65.0
      run: |
        wget https://github.com/Wilfred/difftastic/releases/download/0.65.0/difft-x86_64-unknown-linux-gnu.tar.gz
        tar -xzf difft-x86_64-unknown-linux-gnu.tar.gz
        sudo mv difft /usr/local/bin/
        rm difft-x86_64-unknown-linux-gnu.tar.gz
    - run: difft --version
    - name: Install ANSI to HTML converter
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install ansi2html
    - name: Compare files and generate reports
      run: |
        # Check if files exist
        if [[ ! -f "before.py" ]] || [[ ! -f "after.py" ]]; then
          echo "âŒ Required files not found"
          ls -la *.py || echo "No Python files found"
          exit 1
        fi

        echo "ðŸ“Š Starting comparison..."
        mkdir -p diff-results
        
        DFT_AST_NODE_LIMIT=2000000 difft --width 170 before.py after.py > diff-results/raw.txt 2>&1 || true
        DFT_AST_NODE_LIMIT=2000000 difft --width 170 --color always before.py after.py > diff-results/colored.ansi 2>&1 || true
        cat diff-results/colored.ansi | ansi2html > diff-results/report.html
        
        echo "âœ… Comparison completed"
    - name: Upload comparison results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: file-comparison-reports
        path: diff-results/
        retention-days: 30
name: Difftastic HTML Comparison
on:
  workflow_dispatch:
  push:

jobs:
  compare:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download and setup difftastic
      run: |
        # 下载 difftastic 0.65.0
        wget -q https://github.com/Wilfred/difftastic/releases/download/0.65.0/difft-x86_64-unknown-linux-gnu.tar.gz
        tar -xzf difft-x86_64-unknown-linux-gnu.tar.gz
        sudo mv difft /usr/local/bin/
        chmod +x /usr/local/bin/difft
        
    - name: Run difftastic comparison with HTML output
      run: |
        # 设置环境变量强制使用 Python 解析器
        export DFT_DISABLE_TREE_SITTER=1
        
        # 使用 script 命令模拟 TTY 以确保 HTML 输出正常
        script -q -c "difft --display side-by-side --width 170 --background inline before.py after.py" /dev/null > diff_output.html || true
        
        # 检查输出文件内容和大小
        echo "Generated file size:"
        ls -la diff_output.html
        echo "First 100 characters of output:"
        head -c 100 diff_output.html || echo "File is empty"
        
    - name: Upload diff result
      uses: actions/upload-artifact@v4
      with:
        name: difftastic-html-comparison
        path: diff_output.html
        retention-days: 30